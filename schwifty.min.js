export default class Schwifty{constructor({onload:e=null,selector:t,cacheLimit:o,transitioningAttribute:r,preserveScroll:n=!1,preserveAttributes:a=!1}={}){t=t||`a[href^='${window.location.origin}']:not([data-no-schwifty]), a[href^='/']:not([data-no-schwifty])`,o=o||85,r=r||'data-schwifty';let l=!0===a;'object'!=typeof a&&(a={documentElement:l,head:l,body:l});let i='schwifty-preload',s='link[rel="stylesheet"]',c=document,u=c.documentElement,d='innerHTML',h=new Map,f=new IntersectionObserver((e,t)=>e.forEach(e=>{let r=e.isIntersecting,n=e.target.href;(r||null==r)&&(h.size>=o&&h.delete(h.keys()[0]),h.get(n)?t.unobserve(e.target):E(n))}),{threshold:.5}),p=(e,t=c)=>t.querySelector(e),m=(e,t=c)=>t.querySelectorAll(e),y=e=>e.target.closest(t)||{},b=()=>m(t).forEach(e=>f.observe(e)),v=(e,t=window)=>t.dispatchEvent(new Event(e)),g=e=>e.replace(/m?s/gi,''),w=()=>{let e=getComputedStyle(u);return 1e3*(g(e.transitionDelay)+g(e.transitionDuration))},E=e=>{if(!e)return;let t=new XMLHttpRequest;t.onreadystatechange=function(){200==this.status&&h.set(e,t.responseXML)},t.open('GET',e,!0),t.responseType='document',t.send()},$=t=>{let o=h.get(t);if(!o)return void(location=t);history.replaceState(null,null,t),m(`${s}:not(.${i})`).forEach(e=>{let t=e.href.replace(location.origin,''),r=p(`${s}.${i}[href="${t}"]`),n=p(`${s}[href="${t}"]`,o);n&&!r&&(e.classList.add(i),u.append(e)),!n&&r&&r.remove()});let l=`${s}.${i}`,f=m(`${s}:not(.${i})`,o),y=m(l);for(let e of y)Array.from(f).some(t=>t.href==e.href)||e.remove();['body','head','documentElement'].forEach(e=>{if(a[e])return;let t=c[e];for(let e of t.attributes)t.removeAttribute(e.name);for(let r of o[e].attributes)t.setAttribute(r.name,r.value)}),u.setAttribute(r,'out'),v('pagehide'),v('unload'),setTimeout(()=>{c.body[d]=o.body[d],c.head[d]=o.head[d],u.setAttribute(r,'in'),v('DOMContentLoaded',c),n||scrollTo(0,0),e&&(e.length?e.map(e=>e()):e()),b(),setTimeout(()=>u.removeAttribute(r),w()),v('load'),v('pageshow')},w())};b(),addEventListener('popstate',()=>$(location.href)),addEventListener('click',e=>{let t=y(e).href;t&&(e.preventDefault(),v('beforeunload'),history.pushState(null,null,location.href),$(t))})}}